---
- hosts: all
  become: yes
  tasks:
    - name: Garantir Docker instalado
      shell: |
        if ! command -v docker >/dev/null 2>&1; then
          apt-get update -y
          apt-get install -y docker.io
          systemctl enable --now docker
        else
          echo "✅ Docker já está instalado."
        fi

    - name: Garantir que o serviço Docker está ativo
      shell: |
        systemctl start docker
        systemctl enable docker

    - name: Login no Docker Hub
      shell: |
        echo "{{ DOCKERHUB_TOKEN }}" | docker login -u "{{ DOCKERHUB_USERNAME }}" --password-stdin

    - name: Puxar imagem mais recente
      shell: docker pull "{{ DOCKER_IMAGE }}:latest"

    - name: Parar container antigo (se existir)
      shell: docker stop meuapp-nginx || true

    - name: Remover container antigo (se existir)
      shell: docker rm meuapp-nginx || true

    - name: Subir container atualizado
      shell: |
        docker run -d --name meuapp-nginx \
          -p 80:80 \
          --restart=always \
          "{{ DOCKER_IMAGE }}:latest"

    - name: Exibir containers em execução
      shell: docker ps

