name: Azure VM Free - Terraform + Docker + Ansible

on:
  push:
    branches: [ "main" ]

jobs:
  terraform:
    name: Terraform (criar RG, rede, VM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        env:
          TF_VAR_location:        ${{ secrets.AZURE_LOCATION }}
          TF_VAR_resource_group:  ${{ secrets.RESOURCE_GROUP }}
          TF_VAR_vm_name:         ${{ secrets.VM_NAME }}
          TF_VAR_admin_username:  ${{ secrets.ADMIN_USERNAME }}
          TF_VAR_ssh_public_key:  ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform apply -auto-approve

      - name: Obter IP público da VM
        id: getip
        run: |
          IP=$(az network public-ip show \
               -g "${{ secrets.RESOURCE_GROUP }}" \
               -n "pip-${{ secrets.VM_NAME }}" \
               --query "ipAddress" -o tsv)
          echo "ip=$IP" >> $GITHUB_OUTPUT

  docker_build_push:
    name: Build & Push (Docker Hub)
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image (app JS + NGINX)
        run: docker build -t ${{ secrets.DOCKER_IMAGE }} .

      - name: Push image
        run: docker push ${{ secrets.DOCKER_IMAGE }}

  ansible_deploy:
    name: Ansible (configurar VM e rodar container)
    runs-on: ubuntu-latest
    needs: [terraform, docker_build_push]
    steps:
      - uses: actions/checkout@v4

      - name: Instalar Ansible e coleção Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ansible python3-pip
          ansible-galaxy collection install community.docker

      - name: Criar inventário dinâmico com IP da VM
        run: |
          echo "[web]" > inventory.ini
          echo "${{ needs.terraform.outputs.getip.ip || 'IP_NAO_ENCONTRADO' }} ansible_user=${{ secrets.ADMIN_USERNAME }}" >> inventory.ini
        shell: bash

      - name: Preparar chave privada SSH
        run: |
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > /tmp/private.key
          chmod 600 /tmp/private.key

      - name: Executar playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ansible-playbook -i inventory.ini ansible/playbook.yml \
            --private-key /tmp/private.key \
            -e "docker_image=${{ secrets.DOCKER_IMAGE }}"

